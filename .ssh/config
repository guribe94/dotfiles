# ======================================================================
# GLOBAL DEFAULTS - Apply to all hosts unless overridden
# ======================================================================

Host *
    # Automatically add keys to SSH agent when they're used
    # Why: Saves you from running `ssh-add` manually for each key
    AddKeysToAgent yes
    
    # Default private key to use for authentication
    # Why: Saves you from specifying -i flag or having multiple IdentityFile lines
    IdentityFile ~/.ssh/id_ed25519
    
    # Send keep-alive packets every 60 seconds to prevent connection timeouts
    # Why: Prevents stale connections from being dropped by firewalls/NATs
    ServerAliveInterval 60
    
    # How many consecutive keep-alive packets can be missed before disconnecting
    # Why: With interval 60, this gives ~3 minutes total before giving up
    ServerAliveCountMax 3
    
    # Timeout for initial connection establishment (seconds)
    # Why: Prevents hanging indefinitely on unreachable hosts
    ConnectTimeout 30
    
    # Number of connection attempts before giving up
    # Why: Automatic retries for flaky networks
    ConnectionAttempts 3
    
    # Only use keys explicitly specified in config or command line
    # Why: SECURITY - Prevents SSH from trying every key in your agent
    #      Stops accidental authentication with wrong keys
    IdentitiesOnly yes
    
    # Don't forward SSH agent by default
    # Why: SECURITY - Only enable when you need to jump through bastion hosts
    #      Prevents remote servers from using your local keys
    ForwardAgent no
    
    # Enable compression for better performance on slow connections
    # Why: Can significantly speed up transfers over high-latency links
    #      Modern CPUs are fast, so compression overhead is usually worth it
    Compression yes

# ======================================================================
# macOS-SPECIFIC ENHANCEMENTS
# These only apply on macOS systems (detected via uname)
# ======================================================================

Match exec "uname -s | grep -q Darwin"
    # Ignore UseKeychain directive on systems that don't support it
    # Why: Prevents "Unknown configuration keyword" errors on Linux
    IgnoreUnknown UseKeychain
    
    # Use macOS Keychain to store and retrieve SSH passphrases
    # Why: Convenience - Unlocks your SSH keys automatically using secure storage
    #      Only available on macOS (Apple-specific extension)
    UseKeychain yes
    
    # Re-apply identity file to ensure Keychain integration works properly
    # Why: Keychain setting needs to be associated with specific identity files
    #IdentityFile ~/.ssh/id_rsa
    IdentityFile ~/.ssh/id_ed25519
    
    # Enable connection multiplexing - share one connection for multiple sessions
    # Why: PERFORMANCE - Subsequent connections to same host are instant
    #      Reduces authentication overhead and connection setup time
    ControlMaster auto
    
    # Path template for multiplexing control sockets
    # Why: Isolates sockets by user, host, and port to avoid conflicts
    #      %r=username, %h=hostname, %p=port
    ControlPath ~/.ssh/S.%r@%h:%p
    
    # How long to keep master connection alive after last session closes
    # Why: Convenience - Keeps authentication alive for quick reconnects
    ControlPersist 2h

# ======================================================================
# OPTIONAL: HOST-SPECIFIC CONFIGURATIONS (Examples)
# ======================================================================

# Example for GitHub - uses specific key and settings
# Host github.com
#    IdentityFile ~/.ssh/github_key
#    User git
#    # GitHub doesn't support some advanced features
#    ControlMaster no
#
Host github.com
    AddKeysToAgent yes
    IdentityFile ~/.ssh/id_ed25519

# macOS-specific: Use Keychain for GitHub
Match host github.com exec "uname -s | grep -q Darwin"
    UseKeychain yes


# Example for work bastion host
# Host bastion.mycompany.com
#    User my_username
#    # Forward agent ONLY when you trust the intermediate host
#    ForwardAgent yes
#    # Keep alive more frequently for critical connections
#    ServerAliveInterval 30

# Example for AWS EC2 instances
# Host *.compute.amazonaws.com
#    User ec2-user
#    IdentityFile ~/.ssh/aws_key.pem
#    # AWS often has longer timeouts
#    ConnectTimeout 60
